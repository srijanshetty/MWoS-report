\documentclass[11pt,oneside]{book}
\pagestyle{plain}
\usepackage{graphics}
\usepackage{makeidx}
\usepackage{nomencl}
\usepackage{listings}
\usepackage{multirow}

\textheight=235mm
\textwidth=145mm
\topmargin=0mm
\headheight=0mm
\headsep=0mm
\leftmargin=0mm

% Spacing between rows
\renewcommand{\arraystretch}{1.3}

% These must be changed for double sided output !
\oddsidemargin=15mm
\evensidemargin=15mm

% Custom commands
\newcommand{\mychapter}[2]{
    \setcounter{chapter}{#1}
    \setcounter{section}{0}
    \chapter*{#2}
    \addcontentsline{toc}{chapter}{#2}
}

\makeindex
\makeglossary
\begin{document}

% set line spacing to 1.5B
\baselineskip = 17pt

\title{Multifactor Authentication and Session Support in OpenVPN}
\author{Report submitted in accordance with the requirements of \\
the Indian Institute of Technology, Kanpur \\
by \\
Harshwardhan Sharma (),\\
Shivanshu Agarwal (),\\
Srijan R. Shetty (11727)}
\date{November 2014}
\maketitle
\frontmatter

\chapter{Abstract}
Mozilla uses OpenVPN with MFA via deferred C plugins and pythons scripts.
However, there are several caveats that require non-plugin based modifications,
such as One Time Passwords (OTP) client input and session tracking.
The goal of this project has been to research and provide a first class user experience
to the end user when using MFA with OpenVPN; including the support for session resumption
and backwards compatibility with older versions of OpenVPN.

% Contents not put in table of contents by default so add it separately
\tableofcontents
\addcontentsline{toc}{chapter}{Contents}

% List of figures  not put in table of contents by default so add it separately
\listoffigures
\addcontentsline{toc}{chapter}{List of Figures}


\chapter{Acknowledgement}
The authors would like to thank Professor Dheeraj Sanghi for his continued guidance
and support, Guillaume Destuynder of Mozilla who mentored the authors despite his
hectic schedule and lastly Mozilla for giving the authors an opportunity to work on
a project like OpenVPN under its aegis.\\
The authors wish to thank the University of
Liverpool Computing Services Department for the development of this
\LaTeX \ thesis template.

% Create glossary and add
\printglossary
\addcontentsline{toc}{chapter}{Nomenclature}

\mainmatter

\chapter{OpenVPN}
\section{Introduction}
A Virtual Private network allows two devices to securely communicate with each other
over a possibly insecure public network. This concept when extended to networks
allows for secure communications between different private networks over an
insecure network (most often the internet), thereby creating a virtual super-network.

OpenVPN \footnote{http://openvpn.net} is a GNU General Public
Licensed \footnote{http://www.gnu.org/copyleft/gpl.html} implementation of a
Virtual Private Network written in C maintained by the OpenVPN project.

\section{Architecture}
\textbf{TODO}

\section{Protocol}
OpenVPN uses a custom protocol for communications which is attached in appendix
\ref{OpenVPN:Protocol} on page \pageref{OpenVPN:Protocol} for perusal.

\chapter{Multifactor Authentication}
\section{Introduction}
Multifactor Authentication, henceforth used interchangeably with MFA, hardens access control
by challenging a user on at least two out of the following three factors of authentication.

\begin{enumerate}
    \item \emph{Knowledge Factor}: The knowledge factor of authentication comprises of
        authentication methods which tests the user for the knowledge of a pre-shared secret.
        \emph{"things only the user knows"}. For example: ATM Pins, website passwords.
    \item \emph{Possession Factor}: The possession factor of authentication comprises of
        authentication methods which tests the user for the possession of an entity.
        \emph{"things only the user has"}. For example: Smart cards, ATM Cards.
    \item \emph{Inherence Factor}: The inherence factor of authentication comprises of
        authentication methods which tests the user for possession of \emph{"things only
        the user is"}. For example: Retinal scans, Fingerprint scans.
\end{enumerate}

While conventional methods of authentication only take into account a knowledge factor,
(most internet websites which a username password mechanism to authenticate users)
multi factor authentication includes at least two different factors from the aforementioned
list and might even have multiple authentication methods for a particular factor.

\section{Challenges}
\begin{enumerate}
    \item \textbf{Singled Threaded}: OpenVPN is single threaded process with an event loop which
        allows it to handled concurrent connection requests. Every request fires a timer in OpenVPN
        and if authentication does not succeed before the time quantum expires, the connection is
        reset. The time-out being tried and tested, was not up for modification.
        Considering that current MFA schemes like OTP depend upon non-reliable mechanisms like
        SMS during which the time-out might expire, we made use of the plugin system of OpenVPN
        which allowed for deferred authentication. Hence overcoming the hurdle of time-out
        during authentication.
        (Refer to \ref{MFA:Mechanism} on page \pageref{MFA:Mechanism} for implementation details.)
    \item \textbf{MFA Types}: Multiple solutions are available for multifactor authentication, hence
        there was a need to provide an extensible mechanism to use the different available MFA
        authentication schemes. (Refer to \ref{MFA:Types} on page \pageref{MFA:Types} for
        implementation details.)
    \item \textbf{Backwards Compatibility}: Considering that not all servers will want to support
        MFA, all the changes were introduced in a non breaking fashion.
        (Refer to \ref{MFA:BackwardCompat} on page \pageref{MFA:BackwardCompat} for implementation details.)
    \item \textbf{Defensive Coding}: OpenVPN uses a defensive style of coding by using various
        abstractions for garbage collection, memory allocation to overcome the shortcoming of C.
\end{enumerate}

\section{Implementation}
\subsection{Current Architecture}
The current architecture of OpenVPN supports two key methods:

\begin{enumerate}
    \item \emph{Key Method 1}, the legacy key method only checks for the validity of certificates.
        Refer to Appendix \ref{OpenVPN:Protocol} on page \pageref{OpenVPN:Protocol} for details.
    \item \emph{Key Method 2}, in addition to checking for the validity of certificates, allows for
        authentication of the user through username and password. The verification of username and
        password is delegated to either a script or a plugin which returns a binary result
        indicating a success or failure.
        Refer to Appendix \ref{OpenVPN:Protocol} on page \pageref{OpenVPN:Protocol} for details.
\end{enumerate}

\subsection{Augmentation}
\subsubsection{Packet Structure}
The packet structure of key method 2 - Appendix \ref{OpenVPN:Protocol}, \pageref{OpenVPN:protocol} -
was augmented with the addition of a MFA-username and a MFA-password in the options of the packet
following username and password fields for AUTH-USERPASS. To ensure backwards compatibility, all
augmentations were made at the end of the packet.

\subsubsection{MFA Plugin Types}
\label{MFA:Types}
Three new OpenVPN plugin types have been introduced to support MFA.

\subsubsection{MFA types}
\begin{itemize}
    \item \emph{OTP}: A one time password consist of only a password which can be conveniently
        delivered to the user using SMS, an OTP-stick, or an application like Google Authenticator.
        This corresponds to the plugin type\\
        \textbf{OPENVPN\_PLUGIN\_AUTH\_MFA\_OTP\_VERIFY}.
    \item \emph{USER-PASS}: The conventional username-password scheme requires the user to provide
        both a username and password.
        This corresponds to the plugin type \textbf{OPENVPN\_PLUGIN\_AUTH\_MFA\_PUSH\_VERIFY}.
    \item \emph{PUSH}: No input is required by the user in a push message except the confirmation
        of a push from a pre selected device.
        This corresponds to the plugin type \textbf{OPENVPN\_PLUGIN\_AUTH\_MFA\_USER\_PASS\_VERIFY}.
\end{itemize}

In case of OTP authentication, the username field is set to the Common Name of the user and the OTP
is sent as the password. The Common Name is sent as the username in PUSH with an empty string as
password. The username and password fields are populated with the user supplied values in case of
USER-PASS.

To allow for maximum extensibility of MFA, the actual implementation of each kind of of MFA
is left to the plugin/script writer to prevent a vendor lock down.

\subsubsection{Authentication mechanism}
\label{MFA:Mechanism}
At the time of booting, the plugin/script mentioned in the configuration file is registered
by OpenVPN's plugin system (only one plugin/script is allowed). During authentication, OpenVPN
simply calls the registered plugin/script waits for a success/failure response. On receiving a
success, OpenVPN continues on with the rest of the protocol; and on receiving a failure, OpenVPN
immediately terminates the client connection by sending the client a \emph{SIGTERM} signal.

\section{Configuration}
\subsection{Server}
To enable multifactor authentication in the server using a script, the following line needs to be
included in the configuration file of the server:

\begin{verbatim}
    mfa-method [method-type] [script file name] [via-env/via-file]
\end{verbatim}

\noindent Here method-type is one of 'otp', 'push' or 'user-pass'. For example:
\begin{verbatim}
    mfa-method otp auth.pl via-file
\end{verbatim}

\noindent Multifactor authentication can also be enabled using plugins, the incantation for the same is:
\begin{verbatim}
    mfa-method [method-type]
    plugin [plugin shared object file]
\end{verbatim}

\subsection{Client}
To enable multifactor authentication in the client, the following line needs to be included in the
configuration file of the client:

\begin{verbatim}
    mfa-method [method-type]
\end{verbatim}

\section{Backwards Compatibility}
\label{MFA:BackwardCompat}
The server can allow connections from old client during in the initial transition phase by adding
the following line to its configuration file:

\begin{verbatim}
    mfa-backward-compat
\end{verbatim}

The following scenarios have been addressed under the backwards compatibility flag:\\

{
    \centering
\begin{tabular}{|c|c|c|c|}
    \hline
    \textbf{Compatibility} & \textbf{Server} & \textbf{Client} & \textbf{Action} \\
    \hline
    \multirow{3}{*}{Enabled} & \multirow{3}{*}{New Server, MFA-enabled} & New Client, MFA-Enabled & MFA-auth\\
                             & & New Client, MFA-Disabled & auth-failure\\
                             & & Old Client & old-auth\\
    \hline
    Disabled & New Server, MFA-enabled & Old Client & auth-failure\\
    \hline
    \multirow{2}{*}{*} & \multirow{2}{*}{New Server, MFA-disabled} & New Client, MFA-Enabled & MFA-auth\\
                       & & New Client, MFA-disabled & old-auth\\
    \hline
    * & New Server, MFA-disabled & Old Client & old-auth\\
    \hline
    \multirow{2}{*}{*} & \multirow{2}{*}{Old Server} & New Client, MFA-Enabled & MFA-auth\\
                       & & New Client, MFA-Disabled & MFA-auth\\
    \hline
\end{tabular}
}

\section{Future Work}
\begin{itemize}
    \item \textbf{Session Resumption}: Most web based MFA schemes allow for session resumption,
        wherein MFA authentication is bypassed if the client has authenticated itself within
        a specified time period.
\end{itemize}

\section{Release Notes}
The changes introduced by Multifactor Authentication despite being a complete overhaul of key method
2 constitute only a minor patch according to the Semver specification. \footnote{Semver or Semantic
Versioning is a system of naming software releases as MAJOR.MINOR.PATCH. A major change introduces
breaking changes to software. A minor change introduces non breaking features to software.
A patch introduces non breaking fixes to the software.}

\section{Commit Log}
Refer to Appendix \ref{MFA:Commit} on page \pageref{MFA:Commit} for the commit log.

\appendix
\chapter{OpenVPN Protocol}
\label{OpenVPN:Protocol}
\lstinputlisting{protocol.c}

\chapter{Multifactor Authentication}
\label{MFA:Commit}
\section{Commit Log}
\lstinputlisting{mfa-commit-log}

\chapter{Session Resumption}
\label{Session:Commit}
\section{Commit Log}
\lstinputlisting{session-commit-log}

\bibliographystyle{plain}
\bibliography{thesis}
\addcontentsline{toc}{chapter}{Bibliography}

\printindex
\addcontentsline{toc}{chapter}{Index}

\end{document}
